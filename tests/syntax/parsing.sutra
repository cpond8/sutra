;; Sutra Syntax & Parsing Tests
;;
;; This suite validates the core parsing capabilities of the Sutra engine,
;; ensuring that atoms, collections, and special forms are correctly
;; recognized according to `src/syntax/grammar.pest`.

;;;
;;; 1. Atom Parsing
;;;

(test "parsing: number - integer"
      (expect (value 42) (tags "parsing"))
      42)

(test "parsing: number - negative integer"
      (expect (value -100) (tags "parsing"))
      -100)

(test "parsing: number - float"
      (expect (value 3.14) (tags "parsing"))
      3.14)

(test "parsing: boolean - true"
      (expect (value true) (tags "parsing"))
      true)

(test "parsing: boolean - false"
      (expect (value false) (tags "parsing"))
      false)

(test "parsing: nil"
      (expect (value nil) (tags "parsing"))
      nil)

(test "parsing: string - simple"
      (expect (value "hello") (tags "parsing"))
      "hello")

(test "parsing: string - with escapes"
      (expect (value "a\nb\"c\\d") (tags "parsing"))
      "a\nb\"c\\d")

(test "parsing: string - empty"
      (expect (value "") (tags "parsing"))
      "")

(test "parsing: quote - symbol"
      (expect (value 'foo) (tags "parsing"))
      ''foo)

;;;
;;; 2. Collection Parsing
;;;

(test "parsing: list - quoted"
      (expect (value '(1 "two" true)) (tags "parsing"))
      ''(1 "two" true))

(test "parsing: list - nested quoted"
      (expect (value '(1 (2 (3)))) (tags "parsing"))
      ''(1 (2 (3))))

(test "parsing: block - quoted"
      (expect (value '(+ 1 2)) (tags "parsing"))
      ''{ (+ 1 2) })

;;;
;;; 3. Grammar Error Cases
;;;

(test "parsing: error - unclosed list"
      (expect (error ParseError) (tags "parsing"))
      "(+ 1 2")

(test "parsing: error - unclosed block"
      (expect (error ParseError) (tags "parsing"))
      "{ (get foo) ")

(test "parsing: error - unclosed string"
      (expect (error ParseError) (tags "parsing") (timeout 500))
      "\"not closed")

(test "parsing: error - invalid escape"
      (expect (error ParseError) (tags "parsing"))
      "\"bad\\escape\"")

(test "parsing: error - extra closing paren"
      (expect (error ParseError) (tags "parsing"))
      "(+ 1 2))")

(test "parsing: error - spread outside list"
      (expect (error ParseError) (tags "parsing") (skip "Demonstration of skip feature for test harness."))
      "...oops")